{\rtf1\ansi\ansicpg1252\cocoartf2708
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fnil\fcharset0 Menlo-Regular;}
{\colortbl;\red255\green255\blue255;\red70\green137\blue204;\red14\green18\blue29;\red223\green225\blue230;
\red212\green212\blue212;\red251\green0\blue7;\red251\green0\blue255;\red100\green117\blue135;\red167\green197\blue152;
\red79\green123\blue61;}
{\*\expandedcolortbl;;\cssrgb\c33725\c61176\c83922;\cssrgb\c6667\c9412\c15294;\cssrgb\c89804\c90588\c92157;
\cssrgb\c86275\c86275\c86275;\cssrgb\c100000\c0\c0;\cssrgb\c100000\c0\c100000;\cssrgb\c46667\c53333\c60000;\cssrgb\c70980\c80784\c65882;
\cssrgb\c37647\c54510\c30588;}
\paperw11900\paperh16840\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\deftab720
\pard\pardeftab720\partightenfactor0

\f0\fs24 \cf2 \cb3 \expnd0\expndtw0\kerning0
\outl0\strokewidth0 \strokec2 with\cf4 \strokec4   __dbt__cte__WI__active_worker \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 WITH\cf4 \strokec4  workers_first_last_sessions \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     w\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 as\cf4 \strokec4  worker_id\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3     first_verified_at\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 52\cf5 \strokec5 ,\cf7 \strokec7 getdate\cf5 \strokec5 ()))\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  first_week_tracking\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     us\cf5 \strokec5 .\cf4 \strokec4 started_at\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     cs\cf5 \strokec5 .\cf4 \strokec4 completed_at\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__workers w \cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__user_sessions us \cf2 \strokec2 ON\cf4 \strokec4  w\cf5 \strokec5 .\cf7 \strokec7 user_id\cf4 \strokec4  \cf8 \strokec8 =\cf4 \strokec4  us\cf5 \strokec5 .\cf7 \strokec7 user_id\cf4 \cb1 \strokec4 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__completed_shifts cs \cf2 \strokec2 ON\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 id \cf8 \strokec8 =\cf4 \strokec4  cs\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 and\cf4 \strokec4  cs\cf5 \strokec5 .\cf4 \strokec4 no_show \cf8 \strokec8 =\cf4 \strokec4  \cf2 \strokec2 false\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  first_verified_at \cf8 \strokec8 is\cf4 \strokec4  \cf8 \strokec8 not\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cb1 \
\
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf10 \cb3 \strokec10 -- For workers verified before the first_week tracking, which is the first week they worked inside the date range. This will be the first week of tracking for these workers\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 workers_already_verified_first_week \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     first_verified_at\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     first_week_tracking\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 MIN\cf5 \strokec5 (\cf2 \strokec2 case\cf4 \strokec4  \cb1 \
\cb3             \cf2 \strokec2 when\cf4 \strokec4  started_at \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 4\cf5 \strokec5 ,\cf4 \strokec4 first_week_tracking\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 started_at\cf5 \strokec5 )\cf4 \strokec4  \cb1 \
\cb3             \cf2 \strokec2 when\cf4 \strokec4  completed_at \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 4\cf5 \strokec5 ,\cf4 \strokec4 first_week_tracking\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4  completed_at\cf5 \strokec5 )\cf4 \strokec4  \cb1 \
\cb3             \cf2 \strokec2 else\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  worker_first_week\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  workers_first_last_sessions \cb1 \
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  first_verified_at \cf8 \strokec8 <=\cf4 \strokec4  first_week_tracking\cb1 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf5 \strokec5 ,\cf9 \strokec9 3\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 HAVING\cf4 \strokec4  \cf7 \strokec7 MIN\cf5 \strokec5 (\cf2 \strokec2 case\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3             \cf2 \strokec2 when\cf4 \strokec4  started_at \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 4\cf5 \strokec5 ,\cf4 \strokec4 first_week_tracking\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 started_at\cf5 \strokec5 )\cf4 \strokec4  \cb1 \
\cb3             \cf2 \strokec2 when\cf4 \strokec4  completed_at \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 4\cf5 \strokec5 ,\cf4 \strokec4 first_week_tracking\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4  completed_at\cf5 \strokec5 )\cf4 \strokec4  \cb1 \
\cb3             \cf2 \strokec2 else\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 is\cf4 \strokec4  \cf8 \strokec8 not\cf4 \strokec4  \cf8 \strokec8 null\cf5 \strokec5 ),\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf10 \cb3 \strokec10 -- For workers verified inside the date range, the first week will be the verification week\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 workers_verified_inside_date_range_first_week \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     first_verified_at\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     first_week_tracking\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 first_verified_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  worker_first_week\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  workers_first_last_sessions \cb1 \
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  first_verified_at \cf8 \strokec8 >\cf4 \strokec4  first_week_tracking\cb1 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf5 \strokec5 ,\cf9 \strokec9 3\cf5 \strokec5 ,\cf9 \strokec9 4\cf5 \strokec5 ),\cf4 \cb1 \strokec4 \
\
\
\pard\pardeftab720\partightenfactor0
\cf10 \cb3 \strokec10 -- UNION OF ABOVE TWO TABLES, YIELDING, PER WORKER TRACKED, THE FIRST WEEK OF TRACKING.\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 worker_total \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\cb3     \cf8 \strokec8 *\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 from\cf4 \strokec4  workers_already_verified_first_week \cb1 \
\
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 UNION\cf4 \strokec4  \cb1 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cf8 \strokec8 *\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 from\cf4 \strokec4  workers_verified_inside_date_range_first_week\cf5 \strokec5 )\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 select\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf2 \strokec2 from\cf4 \strokec4  worker_total\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \strokec4   __dbt__cte__WI__workers_weekly_outputs \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 with\cf4 \strokec4  active_workers_weeks \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \strokec4  \cf10 \strokec10 --joining workers and the weeks table\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     \cf2 \strokec2 select\cf4 \strokec4  \cb1 \
\cb3     ws\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf2 \strokec2 as\cf4 \strokec4  worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     ws\cf5 \strokec5 .\cf4 \strokec4 first_verified_at\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     ws\cf5 \strokec5 .\cf4 \strokec4 first_week_tracking\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     ws\cf5 \strokec5 .\cf4 \strokec4 worker_first_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     ww\cf5 \strokec5 .\cf4 \strokec4 date_week \cf2 \strokec2 as\cf4 \strokec4  date_week\cb1 \
\cb3     \cf2 \strokec2 from\cf4 \cb1 \strokec4 \
\cb3         __dbt__cte__WI__active_worker ws\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3         FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_worker_intelligence\cf5 \strokec5 .\cf4 \strokec4 DP_date_week ww\cb1 \
\cb3     \cf2 \strokec2 where\cf4 \strokec4  worker_first_week \cf8 \strokec8 <=\cf4 \strokec4  date_week\cb1 \
\cb3     \cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 workers_bookings_outputs \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \strokec4  \cf10 \strokec10 -- job searching experience output metrics \cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     worker_id\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3     date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 booked_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  booking_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  booked_at \cf8 \strokec8 is\cf4 \strokec4  \cf8 \strokec8 not\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  bookings\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  confirmed_at \cf8 \strokec8 is\cf4 \strokec4  \cf8 \strokec8 not\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  confirmations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  worker_intent \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'cancelled'\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  worker_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 COUNT\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  worker_intent \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'cancelled'\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf7 \strokec7 datediff\cf5 \strokec5 (\cf2 \strokec2 hour\cf5 \strokec5 ,\cf4 \strokec4  cancelled_at\cf5 \strokec5 ,\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 start_time\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 <=\cf4 \strokec4  \cf9 \strokec9 24\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  late_worker_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  employer_intent \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'cancelled'\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  employer_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  employer_intent \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'cancelled'\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf7 \strokec7 datediff\cf5 \strokec5 (\cf2 \strokec2 hour\cf5 \strokec5 ,\cf4 \strokec4  cancelled_at\cf5 \strokec5 ,\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 start_time\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 <=\cf4 \strokec4  \cf9 \strokec9 24\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  late_employer_cancellations\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__worker_shifts ws \cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__shifts s \cf2 \strokec2 ON\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 shift_id \cf8 \strokec8 =\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 id \cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 booked_at\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 56\cf5 \strokec5 ,\cf7 \strokec7 getdate\cf5 \strokec5 ())\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf5 \strokec5 ),\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 workers_completion_outputs \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \strokec4  \cf10 \strokec10 -- shift completion output metrics \cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     cs\cf5 \strokec5 .\cf4 \strokec4 worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     weekly_desired_hours_min\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 completed_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  completion_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  cs\cf5 \strokec5 .\cf4 \strokec4 shift_id\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  shifts_completed\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 SUM\cf5 \strokec5 (\cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 cs\cf5 \strokec5 .\cf4 \strokec4 billable_hours\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  hours_worked\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 SUM\cf5 \strokec5 (\cf4 \strokec4 cs\cf5 \strokec5 .\cf4 \strokec4 no_show::\cf2 \strokec2 int\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  no_shows\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 100.0\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf7 \strokec7 SUM\cf5 \strokec5 (\cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 cs\cf5 \strokec5 .\cf4 \strokec4 billable_hours\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 ))\cf4 \strokec4  \cf8 \strokec8 /\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours_min \cf8 \strokec8 is\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf8 \strokec8 or\cf4 \strokec4  weekly_desired_hours_min \cf8 \strokec8 =\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf9 \strokec9 25\cf4 \strokec4  \cf2 \strokec2 else\cf4 \strokec4  weekly_desired_hours_min \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  worker_fulfilment_rate\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 COUNT\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  clock_in_time\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  clock_in_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  clock_in_time \cf8 \strokec8 <=\cf4 \strokec4  sb\cf5 \strokec5 .\cf4 \strokec4 start_time \cf2 \strokec2 then\cf4 \strokec4  sb\cf5 \strokec5 .\cf4 \strokec4 shift_id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  on_time_clock_in_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 COUNT\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  clock_out_time\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  clock_out_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  clock_out_time \cf8 \strokec8 >=\cf4 \strokec4  sb\cf5 \strokec5 .\cf4 \strokec4 end_time \cf2 \strokec2 then\cf4 \strokec4  sb\cf5 \strokec5 .\cf4 \strokec4 shift_id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  on_time_clock_out_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  clock_in_time \cf8 \strokec8 <=\cf4 \strokec4  sb\cf5 \strokec5 .\cf4 \strokec4 start_time \cf8 \strokec8 and\cf4 \strokec4  clock_out_time \cf8 \strokec8 >=\cf4 \strokec4  sb\cf5 \strokec5 .\cf4 \strokec4 end_time \cf2 \strokec2 then\cf4 \strokec4  sb\cf5 \strokec5 .\cf4 \strokec4 shift_id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  on_time_clock_in_clock_out_amount\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__completed_shifts cs \cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 INNER\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__shift_bookings sb \cf2 \strokec2 on\cf4 \strokec4  cs\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  sb\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 and\cf4 \strokec4  cs\cf5 \strokec5 .\cf4 \strokec4 shift_id \cf8 \strokec8 =\cf4 \strokec4  sb\cf5 \strokec5 .\cf4 \strokec4 shift_id\cb1 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__worker_preferences_generals wpg \cf2 \strokec2 on\cf4 \strokec4  cs\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  wpg\cf5 \strokec5 .\cf4 \strokec4 worker_id\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 completed_at\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 56\cf5 \strokec5 ,\cf7 \strokec7 getdate\cf5 \strokec5 ())\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf5 \strokec5 ,\cf9 \strokec9 3\cf5 \strokec5 ),\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 workers_network_outputs \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \strokec4  \cf10 \strokec10 -- amount of networks\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 created_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  network_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 trusted_network_id\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  networks_amount \cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb_base\cf5 \strokec5 .\cf4 \strokec4 base_appdb_uk__trusted_network_workers  \cb1 \
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  trusted_by_employer \cf8 \strokec8 =\cf4 \strokec4  \cf2 \strokec2 true\cf4 \strokec4  \cb1 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf5 \strokec5 ),\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     \cb1 \
\
\cb3 workers_outputs \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf10 \strokec10 -- Output metrics, for every week on each worker\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     ww\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf2 \strokec2 as\cf4 \strokec4  worker_id\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3     worker_first_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     first_week_tracking\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  worker_first_week \cf8 \strokec8 =\cf4 \strokec4  date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 first_verified_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'new'\cf4 \strokec4  \cf2 \strokec2 else\cf4 \strokec4  \cf6 \strokec6 'existing'\cf4 \strokec4  \cf2 \strokec2 end\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  is_new\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     weekly_desired_hours_min\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3     date_week \cf2 \strokec2 as\cf4 \strokec4  session_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     bookings\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     confirmations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     worker_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     late_worker_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     employer_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     no_shows\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 case\cf4 \strokec4  \cb1 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  hours_worked \cf8 \strokec8 >\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf9 \strokec9 1\cf4 \strokec4  \cf2 \strokec2 else\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 end\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  has_worked\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     shifts_completed\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     hours_worked\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     worker_fulfilment_rate\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     networks_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     on_time_clock_in_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     on_time_clock_out_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     on_time_clock_in_clock_out_amount\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  active_workers_weeks ww\cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  workers_bookings_outputs wbu \cf2 \strokec2 on\cf4 \strokec4  ww\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  wbu\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 and\cf4 \strokec4  date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 ww\cf5 \strokec5 .\cf4 \strokec4 date_week\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 =\cf4 \strokec4  wbu\cf5 \strokec5 .\cf4 \strokec4 booking_week\cb1 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  workers_completion_outputs wcu \cf2 \strokec2 on\cf4 \strokec4  ww\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  wcu\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 and\cf4 \strokec4  date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 ww\cf5 \strokec5 .\cf4 \strokec4 date_week\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 =\cf4 \strokec4  wcu\cf5 \strokec5 .\cf4 \strokec4 completion_week\cb1 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  workers_network_outputs n \cf2 \strokec2 on\cf4 \strokec4  ww\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  n\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 and\cf4 \strokec4  date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 ww\cf5 \strokec5 .\cf4 \strokec4 date_week\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 =\cf4 \strokec4  n\cf5 \strokec5 .\cf4 \strokec4 network_week\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 ORDER\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  worker_id\cf5 \strokec5 ,\cf4 \strokec4  session_week\cf5 \strokec5 )\cf4 \cb1 \strokec4 \
\
\
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf2 \strokec2 FROM\cf4 \strokec4  workers_outputs \cf2 \strokec2 order\cf4 \strokec4  \cf2 \strokec2 by\cf4 \strokec4  worker_id\cf5 \strokec5 ,\cf4 \strokec4  session_Week\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \strokec4   __dbt__cte__WI__workers_overall_outputs \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 WITH\cf4 \strokec4  workers_overall_outputs \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf10 \strokec10 -- Output metrics, Overall. Helps to calculate "hours worked to date", "worker fulfilment rate to date", to be able to highlight historical data on worker\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     w\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 as\cf4 \strokec4  worker_id\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 first_verified_at\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     wpg\cf5 \strokec5 .\cf4 \strokec4 weekly_desired_hours_min\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     wpg\cf5 \strokec5 .\cf4 \strokec4 weekly_desired_hours_max\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     total_networks\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 SUM\cf5 \strokec5 (\cf4 \strokec4 billable_hours\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  total_hours_worked\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 COUNT\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 cs\cf5 \strokec5 .\cf4 \strokec4 shift_id\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  total_shifts_completed\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 SUM\cf5 \strokec5 (\cf4 \strokec4 cs\cf5 \strokec5 .\cf4 \strokec4 no_show::\cf2 \strokec2 int\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  total_no_shows\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__workers w\cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 INNER\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__worker_preferences_generals wpg \cf2 \strokec2 ON\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 id \cf8 \strokec8 =\cf4 \strokec4  wpg\cf5 \strokec5 .\cf4 \strokec4 worker_id\cb1 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__completed_shifts cs \cf2 \strokec2 ON\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 id \cf8 \strokec8 =\cf4 \strokec4  cs\cf5 \strokec5 .\cf4 \strokec4 worker_id\cb1 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 SELECT\cf4 \strokec4  worker_id\cf5 \strokec5 ,\cf4 \strokec4  \cf7 \strokec7 COUNT\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  trusted_by_employer \cf8 \strokec8 =\cf4 \strokec4  \cf2 \strokec2 true\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  trusted_network_id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  total_networks \cf2 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb_base\cf5 \strokec5 .\cf4 \strokec4 base_appdb_uk__trusted_network_workers \cf2 \strokec2 group\cf4 \strokec4  \cf2 \strokec2 by\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 )\cf4 \strokec4  n \cf2 \strokec2 ON\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 id \cf8 \strokec8 =\cf4 \strokec4  n\cf5 \strokec5 .\cf4 \strokec4 worker_id\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf5 \strokec5 ,\cf9 \strokec9 3\cf5 \strokec5 ,\cf9 \strokec9 4\cf5 \strokec5 ,\cf9 \strokec9 5\cf5 \strokec5 ),\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 clock_in_clock_out_outputs \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\
\cb3     \cf2 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\cb3         worker_id\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3         \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  id\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  total_bookings\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 COUNT\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  clock_in_time\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  clock_in_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  clock_in_time \cf8 \strokec8 <=\cf4 \strokec4  start_time \cf2 \strokec2 then\cf4 \strokec4  shift_id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  on_time_clock_in_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 COUNT\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  clock_out_time\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  clock_out_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  clock_out_time \cf8 \strokec8 >=\cf4 \strokec4  end_time \cf2 \strokec2 then\cf4 \strokec4  shift_id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  on_time_clock_out_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  clock_in_time \cf8 \strokec8 <=\cf4 \strokec4  start_time \cf8 \strokec8 and\cf4 \strokec4  clock_out_time \cf8 \strokec8 >=\cf4 \strokec4  end_time \cf2 \strokec2 then\cf4 \strokec4  shift_id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  on_time_clock_in_clock_out_amount\cb1 \
\cb3     \cf2 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__shift_bookings\cb1 \
\cb3     \cf2 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 worker_employer_cancellations \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\
\cb3     \cf2 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\cb3         worker_id\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3         \cf7 \strokec7 COUNT\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  worker_intent \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'cancelled'\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  total_worker_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 COUNT\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  worker_intent \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'cancelled'\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf7 \strokec7 datediff\cf5 \strokec5 (\cf2 \strokec2 hour\cf5 \strokec5 ,\cf4 \strokec4  cancelled_at\cf5 \strokec5 ,\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 start_time\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 <=\cf4 \strokec4  \cf9 \strokec9 24\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  total_late_worker_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 COUNT\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  employer_intent \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'cancelled'\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  total_employer_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 COUNT\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  employer_intent \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'cancelled'\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf7 \strokec7 datediff\cf5 \strokec5 (\cf2 \strokec2 hour\cf5 \strokec5 ,\cf4 \strokec4  cancelled_at\cf5 \strokec5 ,\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 start_time\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 <=\cf4 \strokec4  \cf9 \strokec9 24\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  total_late_employer_cancellations\cb1 \
\cb3     \cf2 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__worker_shifts ws \cb1 \
\cb3     \cf8 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__shifts s \cf2 \strokec2 ON\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 shift_id \cf8 \strokec8 =\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 id \cb1 \
\cb3     \cf2 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 )\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3  \cb1 \
\
\
\
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     o\cf5 \strokec5 .\cf8 \strokec8 *\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     total_bookings\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     clock_in_amount \cf2 \strokec2 as\cf4 \strokec4  total_clock_in_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     clock_out_amount \cf2 \strokec2 as\cf4 \strokec4  total_clock_out_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     on_time_clock_in_amount \cf2 \strokec2 as\cf4 \strokec4  total_on_time_clock_in_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     on_time_clock_in_clock_out_amount \cf2 \strokec2 as\cf4 \strokec4  total_on_time_clock_in_clock_out_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     total_worker_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     total_late_worker_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     total_employer_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     total_late_employer_cancellations\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  workers_overall_outputs o \cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  clock_in_clock_out_outputs c \cf2 \strokec2 ON\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  c\cf5 \strokec5 .\cf4 \strokec4 worker_id \cb1 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  worker_employer_cancellations e \cf2 \strokec2 ON\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  e\cf5 \strokec5 .\cf4 \strokec4 worker_id\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \strokec4   __dbt__cte__WI__worker_utilisation \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 WITH\cf4 \strokec4  final_worker_outputs \cf2 \strokec2 as\cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     o\cf5 \strokec5 .\cf4 \strokec4 worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 session_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 worker_first_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 first_week_tracking\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     o\cf5 \strokec5 .\cf4 \strokec4 first_verified_at\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     is_new\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 weekly_desired_hours_min \cf8 \strokec8 is\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 weekly_desired_hours_max \cf2 \strokec2 else\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 weekly_desired_hours_min \cf2 \strokec2 end\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  weekly_desired_hours\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 datediff\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf4 \strokec4  date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 first_verified_at\cf5 \strokec5 ),\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week\cf5 \strokec5 )\cf4 \strokec4 ::\cf2 \strokec2 int\cf4 \strokec4   \cf2 \strokec2 as\cf4 \strokec4  weeks_since_verification\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     bookings\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     confirmations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 max\cf5 \strokec5 (\cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  has_worked \cf8 \strokec8 =\cf4 \strokec4  \cf9 \strokec9 1\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf2 \strokec2 else\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 over\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 PARTITION\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf2 \strokec2 ORDER\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf2 \strokec2 ROWS\cf4 \strokec4  \cf8 \strokec8 BETWEEN\cf4 \strokec4  \cf2 \strokec2 unbounded\cf4 \strokec4  \cf2 \strokec2 preceding\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf2 \strokec2 current\cf4 \strokec4  \cf2 \strokec2 row\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  latest_working_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 datediff\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf7 \strokec7 max\cf5 \strokec5 (\cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  has_worked \cf8 \strokec8 =\cf4 \strokec4  \cf9 \strokec9 1\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf2 \strokec2 else\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 over\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 PARTITION\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf2 \strokec2 ORDER\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf2 \strokec2 ROWS\cf4 \strokec4  \cf8 \strokec8 BETWEEN\cf4 \strokec4  \cf2 \strokec2 unbounded\cf4 \strokec4  \cf2 \strokec2 preceding\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf2 \strokec2 current\cf4 \strokec4  \cf2 \strokec2 row\cf5 \strokec5 ),\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  weeks_since_last_completed_shift\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf10 \strokec10 --has_worked,  -- output metric\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 round\cf5 \strokec5 (\cf4 \strokec4 worker_fulfilment_rate\cf5 \strokec5 ,\cf4 \strokec4  \cf9 \strokec9 2\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  worker_fulfilment_rate\cf5 \strokec5 ,\cf4 \strokec4  \cf10 \strokec10 -- output metric\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 round\cf5 \strokec5 (\cf9 \strokec9 100.0\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf5 \strokec5 (\cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 total_hours_worked\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 -\cf4 \strokec4  \cf7 \strokec7 SUM\cf5 \strokec5 (\cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 hours_worked\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 over\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 PARTITION\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf2 \strokec2 order\cf4 \strokec4  \cf2 \strokec2 by\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf2 \strokec2 ROWS\cf4 \strokec4  \cf8 \strokec8 BETWEEN\cf4 \strokec4  \cf2 \strokec2 CURRENT\cf4 \strokec4  \cf2 \strokec2 ROW\cf4 \strokec4   \cf8 \strokec8 AND\cf4 \strokec4  \cf2 \strokec2 UNBOUNDED\cf4 \strokec4  \cf2 \strokec2 FOLLOWING\cf5 \strokec5 ))\cf4 \strokec4  \cf8 \strokec8 /\cf4 \strokec4  \cf7 \strokec7 nullif\cf5 \strokec5 ((\cf7 \strokec7 datediff\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf4 \strokec4  first_verified_at\cf5 \strokec5 ,\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week\cf5 \strokec5 )\cf4 \strokec4 ::\cf2 \strokec2 int\cf4 \strokec4  \cf8 \strokec8 +\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 )\cf4 \strokec4   \cf8 \strokec8 *\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 weekly_desired_hours_min\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 ),\cf4 \strokec4  \cf9 \strokec9 4\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  worker_fulfilment_rate_to_date\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 hours_worked\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  hours_worked\cf5 \strokec5 ,\cf4 \strokec4  \cf10 \strokec10 -- output metric\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 round\cf5 \strokec5 (\cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 total_hours_worked\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 -\cf4 \strokec4  \cf7 \strokec7 SUM\cf5 \strokec5 (\cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 hours_worked\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 over\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 PARTITION\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf2 \strokec2 order\cf4 \strokec4  \cf2 \strokec2 by\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf2 \strokec2 ROWS\cf4 \strokec4  \cf8 \strokec8 BETWEEN\cf4 \strokec4  \cf2 \strokec2 CURRENT\cf4 \strokec4  \cf2 \strokec2 ROW\cf4 \strokec4   \cf8 \strokec8 AND\cf4 \strokec4  \cf2 \strokec2 UNBOUNDED\cf4 \strokec4  \cf2 \strokec2 FOLLOWING\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 >=\cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  total_hours_worked \cf8 \strokec8 -\cf4 \strokec4  \cf7 \strokec7 SUM\cf5 \strokec5 (\cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 hours_worked\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 over\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 PARTITION\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf2 \strokec2 order\cf4 \strokec4  \cf2 \strokec2 by\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf2 \strokec2 ROWS\cf4 \strokec4  \cf8 \strokec8 BETWEEN\cf4 \strokec4  \cf2 \strokec2 CURRENT\cf4 \strokec4  \cf2 \strokec2 ROW\cf4 \strokec4   \cf8 \strokec8 AND\cf4 \strokec4  \cf2 \strokec2 UNBOUNDED\cf4 \strokec4  \cf2 \strokec2 FOLLOWING\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 else\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 end\cf5 \strokec5 ,\cf4 \strokec4  \cf9 \strokec9 4\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  hours_worked_to_date\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 shifts_completed\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  shifts_completed\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 total_shifts_completed\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4   \cf8 \strokec8 -\cf4 \strokec4  \cf7 \strokec7 SUM\cf5 \strokec5 (\cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 shifts_completed\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 over\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 PARTITION\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf2 \strokec2 order\cf4 \strokec4  \cf2 \strokec2 by\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf2 \strokec2 ROWS\cf4 \strokec4  \cf8 \strokec8 BETWEEN\cf4 \strokec4  \cf2 \strokec2 CURRENT\cf4 \strokec4  \cf2 \strokec2 ROW\cf4 \strokec4   \cf8 \strokec8 AND\cf4 \strokec4  \cf2 \strokec2 UNBOUNDED\cf4 \strokec4  \cf2 \strokec2 FOLLOWING\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  completed_shifts_to_date\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     total_shifts_completed\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 no_shows\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  no_shows\cf5 \strokec5 ,\cf4 \strokec4  \cf10 \strokec10 -- output metric,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 total_no_shows\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4   \cf8 \strokec8 -\cf4 \strokec4  \cf7 \strokec7 SUM\cf5 \strokec5 (\cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 no_shows\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 over\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 PARTITION\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf2 \strokec2 order\cf4 \strokec4  \cf2 \strokec2 by\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf2 \strokec2 ROWS\cf4 \strokec4  \cf8 \strokec8 BETWEEN\cf4 \strokec4  \cf2 \strokec2 CURRENT\cf4 \strokec4  \cf2 \strokec2 ROW\cf4 \strokec4   \cf8 \strokec8 AND\cf4 \strokec4  \cf2 \strokec2 UNBOUNDED\cf4 \strokec4  \cf2 \strokec2 FOLLOWING\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  no_shows_to_date\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     total_no_shows\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     worker_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     employer_cancellations\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  total_networks \cf8 \strokec8 >\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf9 \strokec9 1\cf4 \strokec4  \cf2 \strokec2 else\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 end\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  is_in_network\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  networks_amount \cf8 \strokec8 >\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf9 \strokec9 1\cf4 \strokec4  \cf2 \strokec2 else\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 end\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  has_joined_new_network\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 total_networks\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4   \cf8 \strokec8 -\cf4 \strokec4  \cf7 \strokec7 SUM\cf5 \strokec5 (\cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 networks_amount\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 over\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 PARTITION\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf2 \strokec2 order\cf4 \strokec4  \cf2 \strokec2 by\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf2 \strokec2 ROWS\cf4 \strokec4  \cf8 \strokec8 BETWEEN\cf4 \strokec4  \cf2 \strokec2 CURRENT\cf4 \strokec4  \cf2 \strokec2 ROW\cf4 \strokec4   \cf8 \strokec8 AND\cf4 \strokec4  \cf2 \strokec2 UNBOUNDED\cf4 \strokec4  \cf2 \strokec2 FOLLOWING\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  networks_to_date\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 case\cf4 \strokec4  \cb1 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weeks_since_last_completed_shift \cf8 \strokec8 =\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 66\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'TOP TIER'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weeks_since_last_completed_shift \cf8 \strokec8 =\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 between\cf4 \strokec4  \cf9 \strokec9 25\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf9 \strokec9 66\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'MEDIUM TIER'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weeks_since_last_completed_shift \cf8 \strokec8 =\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 <\cf4 \strokec4  \cf9 \strokec9 25\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'LOWER TIER'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weeks_since_last_completed_shift \cf8 \strokec8 between\cf4 \strokec4  \cf9 \strokec9 1\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf9 \strokec9 2\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'WARM'\cf4 \strokec4  \cf10 \strokec10 -- start of churn, but churn still recent\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weeks_since_last_completed_shift \cf8 \strokec8 between\cf4 \strokec4  \cf9 \strokec9 2\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf9 \strokec9 3\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'COLD'\cf4 \strokec4  \cf10 \strokec10 -- the workers is becoming cold ! \cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weeks_since_last_completed_shift \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 4\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'LOST'\cf4 \strokec4  \cf10 \strokec10 -- it's super unlikely the worker will come back\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weeks_since_last_completed_shift \cf8 \strokec8 is\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  weeks_since_verification \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 4\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'LOST'\cf4 \strokec4  \cf10 \strokec10 --more weeks than currently tracking\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 end\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  weekly_performance_segment\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 case\cf4 \strokec4  \cb1 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 <=\cf4 \strokec4  \cf9 \strokec9 10\cf4 \strokec4  \cf8 \strokec8 AND\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 <=\cf4 \strokec4  \cf9 \strokec9 25\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'unhappy not demanding flexer'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 <=\cf4 \strokec4  \cf9 \strokec9 10\cf4 \strokec4  \cf8 \strokec8 AND\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 is\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'unhappy not demanding flexer'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 <=\cf4 \strokec4  \cf9 \strokec9 10\cf4 \strokec4  \cf8 \strokec8 AND\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 between\cf4 \strokec4  \cf9 \strokec9 25\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf9 \strokec9 66\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'satisfied not demanding flexer'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 <=\cf4 \strokec4  \cf9 \strokec9 10\cf4 \strokec4  \cf8 \strokec8 AND\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 66\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'happy not demanding flexer'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 between\cf4 \strokec4  \cf9 \strokec9 10\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf9 \strokec9 35\cf4 \strokec4  \cf8 \strokec8 AND\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 <=\cf4 \strokec4  \cf9 \strokec9 25\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'unhappy, demanding flexer'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 between\cf4 \strokec4  \cf9 \strokec9 10\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf9 \strokec9 35\cf4 \strokec4  \cf8 \strokec8 AND\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 is\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'unhappy, demanding flexer'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 between\cf4 \strokec4  \cf9 \strokec9 10\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf9 \strokec9 35\cf4 \strokec4  \cf8 \strokec8 AND\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 between\cf4 \strokec4  \cf9 \strokec9 25\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf9 \strokec9 66\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'satisfied, demanding flexer'\cf4 \strokec4  \cb1 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 between\cf4 \strokec4  \cf9 \strokec9 10\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf9 \strokec9 35\cf4 \strokec4  \cf8 \strokec8 AND\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 66\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'happy, demanding flexer'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 35\cf4 \strokec4  \cf8 \strokec8 AND\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 <=\cf4 \strokec4  \cf9 \strokec9 25\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'unhappy, very demanding flexer'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 35\cf4 \strokec4  \cf8 \strokec8 AND\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 is\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'unhappy, very demanding flexer'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 35\cf4 \strokec4  \cf8 \strokec8 AND\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 between\cf4 \strokec4  \cf9 \strokec9 25\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf9 \strokec9 66\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'satisfied, very demanding flexer'\cf4 \strokec4  \cb1 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 35\cf4 \strokec4  \cf8 \strokec8 AND\cf4 \strokec4  worker_fulfilment_rate \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 66\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'happy, demanding flexer'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  weekly_desired_hours \cf8 \strokec8 is\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'unknown'\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 end\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  weekly_worker_fulfilment_segment\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4   __dbt__cte__WI__workers_weekly_outputs w \cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  __dbt__cte__WI__workers_overall_outputs o \cf2 \strokec2 ON\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  weeks_since_verification \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 0\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf10 \cb3 \strokec10 --ORDER BY worker_id, w.session_week, weekly_desired_hours\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 )\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf2 \strokec2 FROM\cf4 \strokec4  final_worker_outputs \cf2 \strokec2 ORDER\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  worker_id\cf5 \strokec5 ,\cf4 \strokec4  session_week\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \strokec4   __dbt__cte__WI__worker_engagement \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 with\cf4 \strokec4  worker_engagement \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 SELECT\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     w\cf5 \strokec5 .\cf4 \strokec4 id \cf2 \strokec2 as\cf4 \strokec4  worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 us\cf5 \strokec5 .\cf4 \strokec4 created_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  session_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf7 \strokec7 COUNT\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 us\cf5 \strokec5 .\cf4 \strokec4 id\cf5 \strokec5 )),\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  sessions_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf7 \strokec7 AVG\cf5 \strokec5 (\cf7 \strokec7 datediff\cf5 \strokec5 (\cf2 \strokec2 second\cf5 \strokec5 ,\cf4 \strokec4 us\cf5 \strokec5 .\cf4 \strokec4 started_at\cf5 \strokec5 ,\cf4 \strokec4 us\cf5 \strokec5 .\cf4 \strokec4 ended_at\cf5 \strokec5 )),\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  avg_sessions_duration\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__user_sessions us\cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 INNER\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__workers w \cf2 \strokec2 on\cf4 \strokec4  us\cf5 \strokec5 .\cf7 \strokec7 user_id\cf4 \strokec4  \cf8 \strokec8 =\cf4 \strokec4  w\cf5 \strokec5 .\cf7 \strokec7 user_id\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  us\cf5 \strokec5 .\cf4 \strokec4 created_at \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 56\cf5 \strokec5 ,\cf7 \strokec7 getdate\cf5 \strokec5 ())\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf10 \cb3 \strokec10 --and us.started_at != us.ended_at -- avoid irrelevant instantaneous sessions\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 )\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3 session_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf7 \cb3 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 sessions_amount\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  sessions_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cf7 \cb3 \strokec7 round\cf5 \strokec5 (\cf4 \strokec4 avg_sessions_duration\cf5 \strokec5 ,\cf4 \strokec4  \cf9 \strokec9 2\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  avg_sessions_duration\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  worker_engagement\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \strokec4   __dbt__cte__WI__worker_offering_metrics \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 WITH\cf4 \strokec4  offer_sources_flattened \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \strokec4  \cf10 \strokec10 -- Flattening the offer source table, to be able to get, per workers, all the worker shift ids and then offers\cf4 \cb1 \strokec4 \
\
\
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cf2 \strokec2 distinct\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     id \cf2 \strokec2 as\cf4 \strokec4  offer_source_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     offered_at\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3     method\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3     worker_shift_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     shift_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     worker_id \cf8 \strokec8 ||\cf4 \strokec4  \cf6 \strokec6 '_'\cf4 \strokec4  \cf8 \strokec8 ||\cf4 \strokec4  shift_id \cf2 \strokec2 as\cf4 \strokec4  worker_shift_combination\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 from\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_marketplace\cf5 \strokec5 .\cf4 \strokec4 offer_sources_flattened\cb1 \
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  offered_at \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 52\cf5 \strokec5 ,\cf7 \strokec7 getdate\cf5 \strokec5 ())\cf4 \strokec4  \cf10 \strokec10 --and id like '%%'\cf4 \cb1 \strokec4 \
\
\
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 offer_sources_worker_shift \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \strokec4  \cf10 \strokec10 -- adding necessary information on top of (worker, shift, worker_shift_id)\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cf2 \strokec2 DISTINCT\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     o\cf5 \strokec5 .\cf8 \strokec8 *\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 case\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  \cf2 \strokec2 hour\cf5 \strokec5 (\cf4 \strokec4 s\cf5 \strokec5 .\cf4 \strokec4 start_time\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 between\cf4 \strokec4  \cf9 \strokec9 8\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf9 \strokec9 16\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'morning'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  \cf2 \strokec2 hour\cf5 \strokec5 (\cf4 \strokec4 s\cf5 \strokec5 .\cf4 \strokec4 start_time\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 between\cf4 \strokec4  \cf9 \strokec9 16\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf9 \strokec9 23\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'afternoon'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 else\cf4 \strokec4  \cf6 \strokec6 'night'\cf4 \strokec4  \cf2 \strokec2 end\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  time_of_shift\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     j\cf5 \strokec5 .\cf4 \strokec4 role_id \cf2 \strokec2 as\cf4 \strokec4  role_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     l\cf5 \strokec5 .\cf4 \strokec4 venue_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     ws\cf5 \strokec5 .\cf4 \strokec4 worker_intent\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     ws\cf5 \strokec5 .\cf4 \strokec4 booked_at\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  \cf7 \strokec7 datediff\cf5 \strokec5 (\cf2 \strokec2 hour\cf5 \strokec5 ,\cf4 \strokec4  offered_at\cf5 \strokec5 ,\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 start_time\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 /\cf4 \strokec4  \cf9 \strokec9 24\cf4 \strokec4  \cf8 \strokec8 <\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 else\cf4 \strokec4  \cf7 \strokec7 datediff\cf5 \strokec5 (\cf2 \strokec2 hour\cf5 \strokec5 ,\cf4 \strokec4  offered_at\cf5 \strokec5 ,\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 start_time\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 /\cf4 \strokec4  \cf9 \strokec9 24\cf4 \strokec4  \cf2 \strokec2 end\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  shift_notice_days\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     j\cf5 \strokec5 .\cf4 \strokec4 bookable_individually\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     j\cf5 \strokec5 .\cf4 \strokec4 pay_rate\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  offer_sources_flattened o \cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 INNER\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__worker_shifts ws \cf2 \strokec2 ON\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_shift_id \cf8 \strokec8 =\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 id \cb1 \
\cf8 \cb3 \strokec8 INNER\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__shifts s \cf2 \strokec2 ON\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 shift_id \cf8 \strokec8 =\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 id\cb1 \
\cf8 \cb3 \strokec8 INNER\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__jobs j \cf2 \strokec2 ON\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 job_id \cf8 \strokec8 =\cf4 \strokec4  j\cf5 \strokec5 .\cf4 \strokec4 id \cb1 \
\cf8 \cb3 \strokec8 INNER\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__listings l \cf2 \strokec2 oN\cf4 \strokec4  j\cf5 \strokec5 .\cf4 \strokec4 listing_id \cf8 \strokec8 =\cf4 \strokec4  l\cf5 \strokec5 .\cf4 \strokec4 id\cb1 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     \cf5 \strokec5 )\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf10 \cb3 \strokec10 -- It can be that, for the same (worker_id, shift_id), we have two different worker_shift_ids. A often occurent example is\cf4 \cb1 \strokec4 \
\cf10 \cb3 \strokec10 -- When an offer is first sent via progressive offering, and then via reopened_offer \cf4 \cb1 \strokec4 \
\cf10 \cb3 \strokec10 -- so, to really count the amount of shifts offered to a worker, we will not use worker_shift_id, but worker_id + shift_id \cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     \cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cf10 \strokec10 -- computing offering metrics. Opportunity for Work, Intent of Booking, Power of Booking\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     worker_id\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3     date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 offered_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offering_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 worker_shift_combination\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offers_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 venue_id \cf8 \strokec8 ||\cf4 \strokec4  role_id \cf8 \strokec8 ||\cf4 \strokec4  time_of_shift\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  distinct_opportunities_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 100.0\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 venue_id \cf8 \strokec8 ||\cf4 \strokec4  role_id \cf8 \strokec8 ||\cf4 \strokec4  time_of_shift\cf5 \strokec5 ))\cf4 \strokec4  \cf8 \strokec8 /\cf4 \strokec4  \cf7 \strokec7 nullif\cf5 \strokec5 (\cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 worker_shift_combination\cf5 \strokec5 )),\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  opportunity_diversity_rate\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf4 \strokec4 worker_shift_id\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 /\cf4 \strokec4  \cf7 \strokec7 nullif\cf5 \strokec5 (\cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 worker_shift_combination\cf5 \strokec5 )),\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offer_spam\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  worker_intent \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'accepted'\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  worker_shift_combination \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offers_accepted\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 100.0\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  worker_intent \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'accepted'\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  worker_shift_combination \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 /\cf4 \strokec4  \cf7 \strokec7 nullif\cf5 \strokec5 (\cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 worker_shift_combination\cf5 \strokec5 )),\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offer_acceptance_rate\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 avg\cf5 \strokec5 (\cf4 \strokec4 shift_notice_days\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  shift_notice_days_avg\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 avg\cf5 \strokec5 (\cf4 \strokec4 bookable_individually::\cf2 \strokec2 int\cf5 \strokec5 )\cf4 \strokec4 ::\cf2 \strokec2 float\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  bookable_individually_avg\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 avg\cf5 \strokec5 (\cf4 \strokec4 pay_rate::\cf2 \strokec2 float\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  pay_rate_avg\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 100.0\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  method \cf8 \strokec8 like\cf4 \strokec4  \cf6 \strokec6 '%progressive%'\cf4 \strokec4  \cf8 \strokec8 or\cf4 \strokec4  method \cf8 \strokec8 like\cf4 \strokec4  \cf6 \strokec6 '%reopened%'\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  offer_source_id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 /\cf4 \strokec4  \cf7 \strokec7 nullif\cf5 \strokec5 (\cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 offer_source_id\cf5 \strokec5 )),\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  rate_po_reopened_offers\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 100.0\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  \cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  method \cf8 \strokec8 like\cf4 \strokec4  \cf6 \strokec6 '%individual%'\cf4 \strokec4  \cf8 \strokec8 or\cf4 \strokec4  method \cf8 \strokec8 like\cf4 \strokec4  \cf6 \strokec6 '%network%'\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  offer_source_id \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 /\cf4 \strokec4  \cf7 \strokec7 nullif\cf5 \strokec5 (\cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 offer_source_id\cf5 \strokec5 )),\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  rate_individual_network_offers\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  offer_sources_worker_shift\cb1 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \strokec4   __dbt__cte__WI__worker_application_metrics \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 WITH\cf4 \strokec4  workers_applications \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\
\
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 applied_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  application_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  applied_shift_id\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  applications_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     listagg\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  applied_shift_id\cf5 \strokec5 ,\cf4 \strokec4  \cf6 \strokec6 ','\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  applied_shifts\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_marketplace\cf5 \strokec5 .\cf4 \strokec4 job_audits_apply_to_book\cb1 \
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  applied_at \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 52\cf5 \strokec5 ,\cf7 \strokec7 getdate\cf5 \strokec5 ())\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \cb1 \strokec4 \
\
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 workers_applied_per_shifts \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     applied_shift_id \cf2 \strokec2 as\cf4 \strokec4  shift_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     workers_required\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 applied_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  application_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  worker_id\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  applications_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     listagg\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  worker_id\cf5 \strokec5 ,\cf4 \strokec4  \cf6 \strokec6 ','\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  applied_workers_list\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_marketplace\cf5 \strokec5 .\cf4 \strokec4 job_audits_apply_to_book ws \cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 INNER\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__shifts s \cf2 \strokec2 ON\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 applied_shift_id \cf8 \strokec8 =\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 id\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 applied_at \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 52\cf5 \strokec5 ,\cf7 \strokec7 getdate\cf5 \strokec5 ())\cf4 \strokec4  \cb1 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf5 \strokec5 ,\cf9 \strokec9 3\cf5 \strokec5 )\cf4 \cb1 \strokec4 \
\
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 application_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 applications_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 applied_shifts\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 AVG\cf5 \strokec5 (\cf4 \strokec4 s\cf5 \strokec5 .\cf4 \strokec4 applications_amount \cf8 \strokec8 /\cf4 \strokec4  \cf7 \strokec7 nullif\cf5 \strokec5 (\cf4 \strokec4 workers_required\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  avg_application_competition_per_spots\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 MIN\cf5 \strokec5 (\cf4 \strokec4 s\cf5 \strokec5 .\cf4 \strokec4 applications_amount \cf8 \strokec8 /\cf4 \strokec4  \cf7 \strokec7 nullif\cf5 \strokec5 (\cf4 \strokec4 workers_required\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  min_application_competition_per_spots\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  workers_applications w \cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  workers_applied_per_shifts s \cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 ON\cf4 \strokec4  \cf2 \strokec2 position\cf5 \strokec5 (\cf4 \strokec4 s\cf5 \strokec5 .\cf4 \strokec4 shift_id \cf8 \strokec8 in\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 applied_shifts\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 >\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cb1 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf5 \strokec5 ,\cf9 \strokec9 3\cf5 \strokec5 ,\cf9 \strokec9 4\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 ORDER\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \strokec4   __dbt__cte__WI__shifts_liquidity \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 WITH\cf4 \strokec4  offers_per_worker_per_week \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     \cf2 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\cb3     worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 offered_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offering_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     listagg\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 shift_id\cf5 \strokec5 ),\cf6 \strokec6 ','\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  shifts_offered\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 from\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_marketplace\cf5 \strokec5 .\cf4 \strokec4 offer_sources_flattened\cb1 \
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  offered_at \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 52\cf5 \strokec5 ,\cf7 \strokec7 getdate\cf5 \strokec5 ())\cf4 \strokec4  \cf10 \strokec10 --and id like '%%'\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf4 \cb1 \strokec4 \
\
\
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3 shifts_liquidity \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \strokec4  \cf10 \strokec10 -- how fast, offers worker workers receive, get booked\cf4 \cb1 \strokec4 \
\
\cb3     \cf2 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\cb3         shift_id\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3         workers_booked\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 case\cf4 \strokec4  \cb1 \
\cb3             \cf2 \strokec2 when\cf4 \strokec4  workers_booked \cf8 \strokec8 >\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'booked'\cf4 \strokec4  \cf2 \strokec2 else\cf4 \strokec4  \cf6 \strokec6 'unbooked'\cf4 \strokec4  \cf2 \strokec2 end\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  is_booked\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3         \cf7 \strokec7 AVG\cf5 \strokec5 (\cf9 \strokec9 1.0\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf7 \strokec7 datediff\cf5 \strokec5 (\cf2 \strokec2 hour\cf5 \strokec5 ,\cf4 \strokec4 s\cf5 \strokec5 .\cf4 \strokec4 created_at\cf5 \strokec5 ,\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 booked_at\cf5 \strokec5 ))\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  hours_to_book_avg\cb1 \
\cb3     \cf2 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__shifts s \cb1 \
\cb3     \cf8 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_appdb\cf5 \strokec5 .\cf4 \strokec4 fsc_appdb__worker_shifts ws \cf2 \strokec2 ON\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 id \cf8 \strokec8 =\cf4 \strokec4  ws\cf5 \strokec5 .\cf4 \strokec4 shift_id \cb1 \
\cb3     \cf2 \strokec2 WHERE\cf4 \strokec4  s\cf5 \strokec5 .\cf4 \strokec4 created_at \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 52\cf5 \strokec5 ,\cf7 \strokec7 getdate\cf5 \strokec5 ())\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 )\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     o\cf5 \strokec5 .\cf4 \strokec4 worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     o\cf5 \strokec5 .\cf4 \strokec4 offering_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 PERCENTILE_CONT\cf5 \strokec5 (\cf9 \strokec9 0.5\cf5 \strokec5 )\cf4 \strokec4  WITHIN \cf2 \strokec2 GROUP\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 order\cf4 \strokec4  \cf2 \strokec2 by\cf4 \strokec4  hours_to_book_avg\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  median_hours_to_book\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 AVG\cf5 \strokec5 (\cf4 \strokec4 hours_to_book_avg\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  avg_hours_to_book\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 100.0\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf7 \strokec7 SUM\cf5 \strokec5 (\cf2 \strokec2 CASE\cf4 \strokec4  \cf2 \strokec2 WHEN\cf4 \strokec4  is_booked \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'unbooked'\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf9 \strokec9 1\cf4 \strokec4  \cf2 \strokec2 else\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 /\cf4 \strokec4  \cf7 \strokec7 nullif\cf5 \strokec5 (\cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf5 \strokec5 (\cf4 \strokec4 shift_id\cf5 \strokec5 )),\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  unbooked_offered_shifts_perc \cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  offers_per_worker_per_week o \cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  shifts_liquidity s\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 ON\cf4 \strokec4  \cf2 \strokec2 position\cf5 \strokec5 (\cf4 \strokec4 s\cf5 \strokec5 .\cf4 \strokec4 shift_id \cf8 \strokec8 in\cf4 \strokec4  shifts_offered\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 >\cf4 \strokec4  \cf9 \strokec9 0\cf4 \cb1 \strokec4 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \strokec4   __dbt__cte__WI__apply_to_book \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     worker_id\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3     date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 applied_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  application_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  applied_shift_id\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  applications\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  offered_shift_id\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offers_from_applications\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  booked_shift_id\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  bookings_from_applications\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  applied_shift_id\cf5 \strokec5 )\cf4 \strokec4  \cf8 \strokec8 -\cf4 \strokec4  \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  offered_shift_id\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  applications_without_any_offers\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 100.0\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  offers_from_applications \cf8 \strokec8 /\cf4 \strokec4  applications \cf2 \strokec2 as\cf4 \strokec4  apply_to_offer_perc\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 100.0\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  bookings_from_applications \cf8 \strokec8 /\cf4 \strokec4  applications \cf2 \strokec2 as\cf4 \strokec4  apply_to_book_perc\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_marketplace\cf5 \strokec5 .\cf4 \strokec4 job_audits_apply_to_book\cb1 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \strokec4   __dbt__cte__job_audits_offers_claims_outcompetitions \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 WITH\cf4 \strokec4  job_audits_unnest \cf2 \strokec2 AS\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     \cf2 \strokec2 SELECT\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf2 \strokec2 FROM\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_marketplace\cf5 \strokec5 .\cf4 \strokec4 job_audits_flattened \cf2 \strokec2 WHERE\cf4 \strokec4  created_at \cf8 \strokec8 >=\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf4 \strokec4 week\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 52\cf5 \strokec5 ,\cf7 \strokec7 getdate\cf5 \strokec5 ())\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 )\cf4 \cb1 \strokec4 \
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cf10 \strokec10 -- funnel: From offers, to either outcompetition, or booking, or none of the two\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     o\cf5 \strokec5 .\cf4 \strokec4 worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     o\cf5 \strokec5 .\cf4 \strokec4 shift_id \cf2 \strokec2 as\cf4 \strokec4  offered_shift_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     o\cf5 \strokec5 .\cf4 \strokec4 created_at \cf2 \strokec2 as\cf4 \strokec4  offered_at\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     o\cf5 \strokec5 .\cf2 \strokec2 action\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offer_action\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     o\cf5 \strokec5 .\cf4 \strokec4 reason \cf2 \strokec2 as\cf4 \strokec4  offer_source\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     cp\cf5 \strokec5 .\cf4 \strokec4 created_at \cf2 \strokec2 as\cf4 \strokec4  outcompeted_at\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     cp\cf5 \strokec5 .\cf4 \strokec4 shift_id \cf2 \strokec2 as\cf4 \strokec4  outcompeted_shift_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 b\cf5 \strokec5 .\cf4 \strokec4 created_at\cf5 \strokec5 ,\cf4 \strokec4  c\cf5 \strokec5 .\cf4 \strokec4 created_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  booked_at\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 b\cf5 \strokec5 .\cf2 \strokec2 action\cf5 \strokec5 ,\cf4 \strokec4  c\cf5 \strokec5 .\cf2 \strokec2 action\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  booking_action\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 b\cf5 \strokec5 .\cf4 \strokec4 shift_id\cf5 \strokec5 ,\cf4 \strokec4 c\cf5 \strokec5 .\cf4 \strokec4 shift_id\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  booked_shift_id\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 SELECT\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf2 \strokec2 from\cf4 \strokec4  job_audits_unnest \cf2 \strokec2 WHERE\cf4 \strokec4  \cf2 \strokec2 action\cf4 \strokec4  \cf8 \strokec8 IN\cf4 \strokec4  \cf5 \strokec5 (\cf6 \strokec6 'offer_to_candidate'\cf5 \strokec5 ,\cf4 \strokec4  \cf6 \strokec6 'offer_to_multiple_candidates'\cf5 \strokec5 ))\cf4 \strokec4  o\cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 SELECT\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf2 \strokec2 from\cf4 \strokec4  job_audits_unnest \cf2 \strokec2 WHERE\cf4 \strokec4  \cf2 \strokec2 action\cf4 \strokec4  \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'shifts_outcompeted'\cf5 \strokec5 )\cf4 \strokec4  cp \cf2 \strokec2 ON\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  cp\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 AND\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 shift_id\cf8 \strokec8 =\cf4 \strokec4  cp\cf5 \strokec5 .\cf4 \strokec4 shift_id\cb1 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 SELECT\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf2 \strokec2 from\cf4 \strokec4  job_audits_unnest \cf2 \strokec2 WHERE\cf4 \strokec4  \cf2 \strokec2 action\cf4 \strokec4  \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'worker_accept_offer'\cf5 \strokec5 )\cf4 \strokec4  b \cf2 \strokec2 ON\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  b\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 AND\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 shift_id\cf8 \strokec8 =\cf4 \strokec4  b\cf5 \strokec5 .\cf4 \strokec4 shift_id\cb1 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 SELECT\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf2 \strokec2 from\cf4 \strokec4  job_audits_unnest \cf2 \strokec2 WHERE\cf4 \strokec4  \cf2 \strokec2 action\cf4 \strokec4  \cf8 \strokec8 =\cf4 \strokec4  \cf6 \strokec6 'worker_claim_shifts'\cf5 \strokec5 )\cf4 \strokec4  c \cf2 \strokec2 ON\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 AND\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 shift_id\cf8 \strokec8 =\cf4 \strokec4  c\cf5 \strokec5 .\cf4 \strokec4 shift_id\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \strokec4   __dbt__cte__WI__shift_outcompetition \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4 offered_at\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offering_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  offered_shift_id\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offered_shifts\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  outcompeted_shift_id\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  outcompeted_shifts\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 count\cf5 \strokec5 (\cf2 \strokec2 distinct\cf4 \strokec4  booked_shift_id\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  booked_shifts\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 100.0\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  outcompeted_shifts \cf8 \strokec8 /\cf4 \strokec4  offered_shifts \cf2 \strokec2 as\cf4 \strokec4  offered_shift_outcompetition_perc\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 100.0\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  booked_shifts \cf8 \strokec8 /\cf4 \strokec4  offered_shifts \cf2 \strokec2 as\cf4 \strokec4  offered_shift_booking_perc\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  __dbt__cte__job_audits_offers_claims_outcompetitions \cb1 \
\cf2 \cb3 \strokec2 GROUP\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  \cf9 \strokec9 1\cf5 \strokec5 ,\cf9 \strokec9 2\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 ),\cf4 \strokec4 worker_intelligence \cf2 \strokec2 as\cf4 \strokec4  \cf5 \strokec5 (\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf4 \cb3     \cf2 \strokec2 SELECT\cf4 \strokec4  \cb1 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 worker_id\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3      w\cf5 \strokec5 .\cf4 \strokec4 session_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 first_verified_at\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 weeks_since_verification\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 weekly_desired_hours\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 latest_working_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 weeks_since_last_completed_shift\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 max\cf5 \strokec5 (\cf2 \strokec2 case\cf4 \strokec4  \cf2 \strokec2 when\cf4 \strokec4  e\cf5 \strokec5 .\cf4 \strokec4 sessions_amount \cf8 \strokec8 >\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf2 \strokec2 else\cf4 \strokec4  \cf8 \strokec8 null\cf4 \strokec4  \cf2 \strokec2 end\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 over\cf4 \strokec4  \cf5 \strokec5 (\cf2 \strokec2 PARTITION\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf2 \strokec2 ORDER\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  e\cf5 \strokec5 .\cf4 \strokec4 session_week \cf2 \strokec2 ROWS\cf4 \strokec4  \cf8 \strokec8 BETWEEN\cf4 \strokec4  \cf2 \strokec2 unbounded\cf4 \strokec4  \cf2 \strokec2 preceding\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  \cf2 \strokec2 current\cf4 \strokec4  \cf2 \strokec2 row\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  latest_login_week\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 w\cf5 \strokec5 .\cf4 \strokec4 worker_fulfilment_rate\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  worker_fulfilment_rate\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 w\cf5 \strokec5 .\cf4 \strokec4 worker_fulfilment_rate_to_date\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  worker_fulfilment_rate_to_date\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 hours_worked\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 hours_worked_to_date\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 bookings\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 shifts_completed\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 total_shifts_completed\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 completed_shifts_to_date\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     w\cf5 \strokec5 .\cf4 \strokec4 weekly_performance_segment\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     e\cf5 \strokec5 .\cf4 \strokec4 sessions_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     e\cf5 \strokec5 .\cf4 \strokec4 avg_sessions_duration\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 case\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 hours_worked \cf8 \strokec8 >\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'working'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 hours_worked \cf8 \strokec8 =\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  e\cf5 \strokec5 .\cf4 \strokec4 sessions_amount \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 1\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'seeking'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 when\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 hours_worked \cf8 \strokec8 =\cf4 \strokec4  \cf9 \strokec9 0\cf4 \strokec4  \cf8 \strokec8 and\cf4 \strokec4  a\cf5 \strokec5 .\cf4 \strokec4 applications_amount \cf8 \strokec8 >=\cf4 \strokec4  \cf9 \strokec9 1\cf4 \strokec4  \cf2 \strokec2 then\cf4 \strokec4  \cf6 \strokec6 'seeking'\cf4 \cb1 \strokec4 \
\cb3         \cf2 \strokec2 else\cf4 \strokec4  \cf6 \strokec6 'dormant'\cf4 \cb1 \strokec4 \
\cb3     \cf2 \strokec2 end\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  activity_status\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 o\cf5 \strokec5 .\cf4 \strokec4 offers_amount\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offers_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 o\cf5 \strokec5 .\cf4 \strokec4 distinct_opportunities_amount\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  distinct_opportunities_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 o\cf5 \strokec5 .\cf4 \strokec4 opportunity_diversity_rate\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  opportunity_diversity_rate\cf5 \strokec5 ,\cf4 \strokec4  \cb1 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 o\cf5 \strokec5 .\cf4 \strokec4 offer_spam\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offer_spam\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 a\cf5 \strokec5 .\cf4 \strokec4 applications_amount\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  applications_amount\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 o\cf5 \strokec5 .\cf4 \strokec4 offers_accepted\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offers_accepted\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 o\cf5 \strokec5 .\cf4 \strokec4 offer_acceptance_rate\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offer_acceptance_rate\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 o\cf5 \strokec5 .\cf4 \strokec4 shift_notice_days_avg\cf5 \strokec5 ,\cf4 \strokec4  \cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offers_shift_notice_days_avg\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf9 \strokec9 100\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 o\cf5 \strokec5 .\cf4 \strokec4 bookable_individually_avg\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offers_bookable_individually_rate\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 o\cf5 \strokec5 .\cf4 \strokec4 pay_rate_avg\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  offers_pay_rate_avg\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 o\cf5 \strokec5 .\cf4 \strokec4 rate_po_reopened_offers\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 AS\cf4 \strokec4  po_reopened_offers_rate\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 o\cf5 \strokec5 .\cf4 \strokec4 rate_individual_network_offers\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 AS\cf4 \strokec4  individual_network_offers_rate\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     is_in_network\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 has_joined_new_network\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  has_joined_new_network\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf7 \strokec7 coalesce\cf5 \strokec5 (\cf4 \strokec4 networks_to_date\cf5 \strokec5 ,\cf9 \strokec9 0\cf5 \strokec5 )\cf4 \strokec4  \cf2 \strokec2 as\cf4 \strokec4  networks_to_date\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     a\cf5 \strokec5 .\cf4 \strokec4 avg_application_competition_per_spots\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     a\cf5 \strokec5 .\cf4 \strokec4 min_application_competition_per_spots\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf10 \strokec10 --avg_hours_to_book as avg_offered_shift_liquidity_hours,\cf4 \cb1 \strokec4 \
\cb3     \cf10 \strokec10 --unbooked_offered_shifts_perc,\cf4 \cb1 \strokec4 \
\cb3     is_verified_for_new_role\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     avg_city_role_spots_fulfilment_rate\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     avg_worker_to_spots_ratio\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     avg_worker_to_next_two_weeks_spots_ratio\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     min_city_role_worker_competition\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     \cf10 \strokec10 --total_city_roles_spots_amount,\cf4 \cb1 \strokec4 \
\cb3     \cf10 \strokec10 --total_city_roles_next_two_weeks_spots_amount,\cf4 \cb1 \strokec4 \
\cb3     apply_to_offer_perc\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     apply_to_book_perc\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     offered_shift_outcompetition_perc\cf5 \strokec5 ,\cf4 \cb1 \strokec4 \
\cb3     offered_shift_booking_perc\cb1 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 FROM\cf4 \strokec4  __dbt__cte__WI__worker_utilisation w\cb1 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  __dbt__cte__WI__worker_engagement e \cf2 \strokec2 ON\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  e\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 and\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf8 \strokec8 =\cf4 \strokec4  e\cf5 \strokec5 .\cf4 \strokec4 session_week\cb1 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  __dbt__cte__WI__worker_offering_metrics o \cf2 \strokec2 ON\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 and\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf8 \strokec8 =\cf4 \strokec4  o\cf5 \strokec5 .\cf4 \strokec4 offering_week\cb1 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  __dbt__cte__WI__worker_application_metrics a \cf2 \strokec2 ON\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  a\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 and\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf8 \strokec8 =\cf4 \strokec4  a\cf5 \strokec5 .\cf4 \strokec4 application_week\cb1 \
\pard\pardeftab720\partightenfactor0
\cf10 \cb3 \strokec10 --LEFT JOIN __dbt__cte__WI__shifts_liquidity sl ON w.worker_id = sl.worker_id and w.session_week = sl.offering_week\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  FLEX_CUSTOM_DEV\cf5 \strokec5 .\cf4 \strokec4 dbt_strategy_worker_intelligence\cf5 \strokec5 .\cf4 \strokec4 WI__worker_supply_demand_balance sd \cf2 \strokec2 ON\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  sd\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 and\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf8 \strokec8 =\cf4 \strokec4  sd\cf5 \strokec5 .\cf4 \strokec4 session_week\cb1 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  __dbt__cte__WI__apply_to_book ab \cf2 \strokec2 ON\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  ab\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 and\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf8 \strokec8 =\cf4 \strokec4  ab\cf5 \strokec5 .\cf4 \strokec4 application_week\cb1 \
\cf8 \cb3 \strokec8 LEFT\cf4 \strokec4  \cf8 \strokec8 JOIN\cf4 \strokec4  __dbt__cte__WI__shift_outcompetition so \cf2 \strokec2 ON\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 =\cf4 \strokec4  so\cf5 \strokec5 .\cf4 \strokec4 worker_id \cf8 \strokec8 and\cf4 \strokec4  w\cf5 \strokec5 .\cf4 \strokec4 session_week \cf8 \strokec8 =\cf4 \strokec4  so\cf5 \strokec5 .\cf4 \strokec4 offering_week\cb1 \
\pard\pardeftab720\partightenfactor0
\cf5 \cb3 \strokec5 )\cf4 \cb1 \strokec4 \
\
\
\
\
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 SELECT\cf4 \strokec4  \cf8 \strokec8 *\cf4 \strokec4  \cf2 \strokec2 FROM\cf4 \strokec4  worker_intelligence \cb1 \
\cf2 \cb3 \strokec2 WHERE\cf4 \strokec4  weeks_since_last_completed_shift \cf8 \strokec8 <=\cf4 \strokec4  \cf9 \strokec9 6\cf4 \strokec4  \cf10 \strokec10 -- we don't want to track anymore a worker if he/she is not doing anything, until he/she comes back\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf8 \cb3 \strokec8 AND\cf4 \strokec4  session_week \cf8 \strokec8 >=\cf4 \strokec4  date_trunc\cf5 \strokec5 (\cf6 \strokec6 'week'\cf5 \strokec5 ,\cf4 \strokec4  \cf7 \strokec7 dateadd\cf5 \strokec5 (\cf7 \strokec7 year\cf5 \strokec5 ,\cf8 \strokec8 -\cf9 \strokec9 1\cf5 \strokec5 ,\cf7 \strokec7 getdate\cf5 \strokec5 ()))\cf4 \strokec4  \cf10 \strokec10 -- making sure we are tracking data from where we wanted to track data\cf4 \cb1 \strokec4 \
\pard\pardeftab720\partightenfactor0
\cf2 \cb3 \strokec2 ORDER\cf4 \strokec4  \cf2 \strokec2 BY\cf4 \strokec4  worker_id\cf5 \strokec5 ,\cf4 \strokec4  session_week\cb1 \
\
}